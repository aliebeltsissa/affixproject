<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="https://unpkg.com/jspsych@7.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>
    <link href="https://unpkg.com/jspsych@7.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    
  </head>
  <style>
    @font-face {
      font-family: "BACS";
      src: url('BACS1.otf') format('opentype'); 
    };
    @font-face {
      font-family: "arial";
      src: url('arial.ttf') format('truetype'); 
    };
  </style>
  <body></body>
  <script>
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData(); /* when all trials finished, display data */
      }
    });

    function FisherYatesShuffle(array) {
      var m = array.length, t, i;
      while (m) {
        i = Math.floor(Math.random() * m--);
        t = array[m];
        array[m] = array[i];
        array[i] = t;
      }
    return array;
    };

    var timeline = [];

    var consent = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p style="text-align:left;">I express my consent to participate in the study and further declare (please click on the boxes below):</p>',
      html: `<p style="text-align:left;"><input name="consent1" type="radio" id="YES1" value="YES" required/><label for="YES1">to have carefully read the explanations relating to this study and to the entirety of the experimental procedure;</label></p>
      <p style="text-align:left;"><input name="consent2" type="radio" id="YES2" value="YES" required/><label for="YES2">to have been made aware of the goals and objectives of the study in question;</label></p>
      <p style="text-align:left;"><input name="consent3" type="radio" id="YES3" value="YES" required/><label for="YES3">to have had the possibility to ask questions regarding any aspect of the experimental procedure and to have received satisfactory answers;</label></p>
      <p style="text-align:left;"><input name="consent4" type="radio" id="YES4" value="YES" required/><label for="YES4"> to be aware of any discomfort possibly caused by the experiment;</label></p>
      <p style="text-align:left;"><input name="consent5" type="radio" id="YES5" value="YES" required/><label for="YES5">to have received sufficient assurances on the confidentiality of information obtained from the following tests;</label></p>
      <p style="text-align:left;"><input name="consent6" type="radio" id="YES6" value="YES" required/><label for="YES6">to be aware that it's possible to stop participating at any phase of the study.</label></p><p>`
    };
    timeline.push(consent);

    // MORPHEME TRAINING //
    const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'Y', 'Z', 'a', 'b', 'c', 'd', 'g', 'h', 'i', 'k', 'l', 'm', 'o', 'r', 't', 'u', 'v', 'y','BACKSPACE']
    var letters_buttons = [];
    for (let i=0;i<letters.length;i++) {
      var letter = letters[i];
      if (letter != 'BACKSPACE'){ // display in BACS
        letters_buttons.push('<span style="font-family:BACS;font-size:40px">' + letter + '</span>')
      } else { // display in Latin characters (arial)
        letters_buttons.push('<span style="font-size:20px;font-family:arial">' + letter + '</span>')
      }
    };

    var words = ['MouSE','BARK','HorSE','Rack','STANK','MailmaN'];
    var words = FisherYatesShuffle(words);
    var stimuli = [];
    for (let i=0; i<words.length; i++) {
      var word = words[i];
      var stimulus = '<p style="font-size: 30px;color:blue">Please spell this word:</p><p style="font-size: 50px;font-family:BACS;color:blue">'+word+'</p><p style="font-size: 50px;font-family:BACS"><p style="font-size: 50px;color:white">i</p>';
      stimuli.push({'stimulus':stimulus, 'word':word, 'length':(stimulus.length-42)}) // length of the stimulus string, without the hidden new line
    };
        
    var morph_training = {
      type: jsPsychHtmlButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: letters_buttons,
      data: {
        'word': jsPsych.timelineVariable('word'),
        'stimulus': jsPsych.timelineVariable('stimulus')
      },
      on_finish: function(data){
        var length = jsPsych.timelineVariable('length');
        if (data.stimulus.slice(-2,) == 'p>') { // if first time displaying that word
           var inter_stim = data.stimulus.slice(0,-44) // delete extra space
        } else {
          var inter_stim = data.stimulus
        };
        if (letters[data.response] != 'BACKSPACE') {
          data.new_stim = inter_stim + letters[data.response]; // previous stimulus + inputted key
        } else {
          data.new_stim = inter_stim.slice(0,data.stimulus.length-1);
        };
        data.input = data.new_stim.slice(length-2);
        if (data.new_stim.slice(-2,) == '">') { // if do BACKSPACE all the way to the start
          data.new_stim = data.new_stim + '<p style="font-size: 50px;color:white">i</p>'
        };
        for (let i=0; i<words.length; i++) {
          if (words[i] == data.word) {
            var trial = stimuli[i];
            trial['stimulus'] = jsPsych.data.getLastTrialData().select('new_stim').values[0];
            data.stimuli = stimuli;
          }
        };
        console.log(inter_stim);
        console.log(data.input);
        console.log(data.new_stim)
      }
    };

    var check = {
      timeline: [morph_training],
      conditional_function: function(){
        var input = jsPsych.data.getLastTrialData().select('input').values[0];
        for (let i = 0; i < words.length; i++) {
          if (input == words[i]) {
            var progression = false;
            break;
          } else {
            var progression = true;
          }
        } ;
        return progression
      },
      on_finish: function(data){
        data.input = jsPsych.data.getLastTrialData().select('input').values[0];
        var trial = stimuli[i];
        trial['stimulus'] = jsPsych.data.getLastTrialData().select('new_stim').values[0];
        data.stimuli = stimuli;
        console.log(stimuli)
      }
    };

    var repeat = {
      timeline: [morph_training, check],
      loop_function: function(){
        var input = jsPsych.data.getLastTrialData().select('input').values[0];
        for (let i = 0; i < words.length; i++) {
          if (input == words[i]) {
            return false;
          }
        }
        return true;
      }
    };

    var training_procedure = {
      timeline: [morph_training,check,repeat],
      timeline_variables: stimuli,
    };
    timeline.push(training_procedure);









    var questionnaire = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>If you want to repeat this trial, press 'r'.`,
      choices: [' ', 'r']
    };

    var error = {
      type: jsPsychInstructions,
      pages: [`You wanted to repeat this trial. Click 'Continue' to do so.`],
      button_label_next: "Continue",
      show_clickable_nav: true,
      allow_backward: false,
      data: {name: 'use_prb'}
    };

    var check = {
      timeline: [error],
      conditional_function: function(){
        var lasttrial_response = jsPsych.data.getLastTrialData().select('response').values[0];
        if(lasttrial_response == 'r') {
          return true;
        } else {
          return false
        }
      }
    }

    var repeat = {
      timeline: [questionnaire, check],
      loop_function: function(){
        var lasttrial_name = jsPsych.data.getLastTrialData().select('name').values[0];
        if(lasttrial_name == 'use_prb') {
          return true;
        } else {
          return false
        }
      }
    }

    var testing_procedure = {
      timeline: [questionnaire, check, repeat]
    };
    timeline.push(testing_procedure);

    var done = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "All done!"
    };
    timeline.push(done); /* add trial to end of timeline */

















    var questionnaire = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>If you want to repeat this trial, press 'r'.`,
      choices: [' ', 'r']
    };

    var error = {
      type: jsPsychInstructions,
      pages: [`You wanted to repeat this trial. Click 'Continue' to do so.`],
      button_label_next: "Continue",
      show_clickable_nav: true,
      allow_backward: false,
      data: {name: 'use_prb'}
    };

    var check = {
      timeline: [error],
      conditional_function: function(){
        var lasttrial_response = jsPsych.data.getLastTrialData().select('response').values[0];
        if(lasttrial_response == 'r') {
          return true;
        } else {
          return false
        }
      }
    }

    var repeat = {
      timeline: [questionnaire, check],
      loop_function: function(){
        var lasttrial_name = jsPsych.data.getLastTrialData().select('name').values[0];
        if(lasttrial_name == 'use_prb') {
          return true;
        } else {
          return false
        }
      }
    }

    var testing_procedure = {
      timeline: [questionnaire, check, repeat]
    };
    timeline.push(testing_procedure);

    var done = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "All done!"
    };
    timeline.push(done); /* add trial to end of timeline */


    var preload = { /* preload images to be used so there's no lag later */
      type: jsPsychPreload,
      images: ['img/blue.png', 'img/orange.png']
    };
    timeline.push(preload);

    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Welcome to the experiment. Press any key to begin."
    };
    timeline.push(welcome); /* add trial to end of timeline */

    var instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p>In this experiment, a circle will appear in the center 
        of the screen.</p><p>If the circle is <strong>blue</strong>, 
        press the letter F on the keyboard as fast as you can.</p>
        <p>If the circle is <strong>orange</strong>, press the letter J 
        as fast as you can.</p>
        <div style='width: 700px;'>
        <div style='float: left;'><img src='img/blue.png'></img>
        <p class='small'><strong>Press the F key</strong></p></div>
        <div style='float: right;'><img src='img/orange.png'></img>
        <p class='small'><strong>Press the J key</strong></p></div>
        </div>
        <p>Press any key to begin.</p>
      `,
      post_trial_gap: 2000
    };
    timeline.push(instructions);

    var test_stimuli = [ /* array for types of trials to show & correct responses */
      { stimulus: "img/blue.png", correct_response: 'f'},
      { stimulus: "img/orange.png", correct_response: 'j'}
    ];

    var fixation = { /* fixation cross between stimuli trials */
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS", /* no keys accepted */
      trial_duration: function(){ /* show cross for isi */
        return jsPsych.randomization.sampleWithoutReplacement([250,500,750,1000,1250,1500,1750,2000], 1)[0]; /* sample 1 item, enter '0' to get item of index 0 from sampling */
      },
      data: {
        task: 'fixation'
      }
    };

    var test = { /* substitute value of parameter in from timeline variables */
      type: jsPsychImageKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: ['f', 'j'],
      data: {
        task: 'response', /* tag responses for output */
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_finish: function(data){ /* sort responses as (in)correct */
        data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
      }
    };

    var test_procedure = { /* link test_stimuli array with test */
      timeline: [fixation, test],
      timeline_variables: test_stimuli,
      repetitions: 5,
      randomize_order: true
    };
    timeline.push(test_procedure); /* add test_procedure to timeline */

    var debrief_block = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        var trials = jsPsych.data.get().filter({task: 'response'}); /* take all data, filter by when the task is to respond */
        var correct_trials = trials.filter({correct: true});
        var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
        var rt = Math.round(correct_trials.select('rt').mean()); /* only look at RTs on trials */

        return `<p>You responded correctly on ${accuracy}% of the trials.</p>
          <p>Your average response time was ${rt}ms.</p>
          <p>Press any key to complete the experiment. Thank you!</p>`;
      }
    };
    timeline.push(debrief_block)

    jsPsych.run(timeline); /* run experiment */
  </script>
</html>
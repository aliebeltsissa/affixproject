<!DOCTYPE html>
<html>
  <head>
    <title>Esperimento di parole aliene</title>
    <!-- jsPsych & Pavlovia -->
    <script src="lib/vendors/jspsych-7.1.2/jspsych.js"></script>
    <script type="text/javascript" src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>
    <!-- preload & setup -->
    <script src="lib/vendors/jspsych-7.1.2/plugin-preload.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-fullscreen.js"></script>
    <!-- response plugins-->
    <script src="lib/vendors/jspsych-7.1.2/plugin-html-keyboard-response.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-image-keyboard-response.js"></script>
    <!-- survey plugins -->
    <script src="lib/vendors/jspsych-7.1.2/plugin-html-button-response.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.1"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey-multi-select.js"></script>
    <!-- formatting & styling -->
    <script type="text/javascript" src="lib/vendors/jquery-2.2.0.min.js"></script>
    <link rel="stylesheet" href="lib/vendors/jspsych-7.1.2/jspsych.css">
    <link rel="stylesheet" href="survey.css">
    <meta charset="utf-8"/>
  </head>
  <style>
    @font-face {
      font-family: "BACS";
      src: url('BACS1.otf') format('opentype'); 
    };
  </style>
  <body></body>
  <script>
    /* ========== INITIALISATION ========== */
    var jsPsych = initJsPsych({
      on_finish: function() {
        window.location = "https://app.prolific.co/submissions/complete?cc=BASLAL2023" // redirect Prolific participants to completed submission page
      }
    });
    
    // capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id
    });

    var timeline = [];

    // open connection with Pavlovia
    var pavlovia_init = {
      type: jsPsychPavlovia,
      command: "init"
    };
    timeline.push(pavlovia_init);

    /* ========== WORD_GENERATION SCRIPT ========== */
    function import_morphemes() {
      const L1affixes_list = ['JQA', 'LcO', 'Ald', 'mkc', 'Nac', 'kbu', 'aQr', 'rAm', 'YbN', 'GUa', 'Ymb', 'kam', 'uvJ', 'kYL', 'ark', 'YkZ', 'YLU', 'cbm', 'lLG', 'bLd', 'cUN', 'vcb', 'uUY', 'mZb', 'dUr', 'QGb', 'vJQ', 'Qru', 'rGl', 'Glu', 'rba', 'mLJ', 'LaA', 'Arv', 'uda', 'mvG', 'lvk', 'UZu', 'UbG', 'Jud', 'OcN', 'JUG', 'lGc', 'kmU', 'JcL', 'NUZ', 'YNu', 'JZr', 'uZc', 'rab', 'Zckv', 'ravu', 'uOAO', 'OcZJ', 'JUNa', 'rNlZ', 'NYZu', 'dYAJ', 'YUYa', 'kdrO', 'ZvkL', 'OJlN', 'YaOk', 'kGua', 'vUdm', 'Grub', 'Grbk', 'UdvY', 'QONk', 'kuvb', 'OJNk', 'crdY', 'ukbY', 'LYGA', 'NmAG', 'rAJu', 'YZUZ', 'Yaum', 'ZAUu', 'AZbl', 'Avdk', 'rZYd', 'GUOA', 'OQAr', 'GQYQ', 'uUmb', 'YZJO', 'LUOk', 'vAvb', 'dmkv', 'badk', 'QvlZ', 'rkra', 'cYUv', 'JcUk', 'LkNc', 'kJdr', 'YArG', 'AOUl', 'rULv'];
      const L1stems_list = ['ukcY', 'bYuQ', 'adkr', 'bvkr', 'mrOd', 'Udbd', 'bvuZ', 'rkYL', 'rckO', 'rvAJ', 'YQbc', 'Yadr', 'YJkb', 'kNua', 'mdla', 'ldAa', 'amJm', 'LGkA', 'aONd', 'krGu', 'UvOG', 'OZkb', 'NaJb', 'vQdO', 'alJY', 'vclY', 'JvaA', 'LQur', 'ArQu', 'rLaZ', 'GZJY', 'vAar', 'JAaG', 'JauQ', 'krUQ', 'kZUb', 'Gabk', 'uauO', 'vYLU', 'rkJu', 'kulZ', 'udkm', 'cAZu', 'YZJm', 'OkGY', 'UmNJ', 'uAkr', 'YOZN', 'AlNU', 'JNka', 'rLkm', 'LdQv', 'AlUY', 'mbZl', 'bmbN', 'rvUb', 'lkAk', 'bGuO', 'lZcu', 'uvaU', 'aUZA', 'Ydud', 'UrOQ', 'AJLr', 'lrZG', 'vblr', 'aYQm', 'dkLl', 'GAcY', 'NvYJ', 'ALGZ', 'NQZv', 'JdGm', 'kGlU', 'NkUA', 'UaYL', 'GJZm', 'dNZA', 'vJab', 'GQrc', 'JmNk', 'UJkG', 'LuaU', 'lmbY', 'UJmr', 'aYaN', 'ZdlO', 'JrGv', 'ukYZ', 'mcOJ', 'muYN', 'NJZl', 'Abka', 'OJGQ', 'Nulk', 'lGZv', 'dJNr', 'lcOc', 'YcdO', 'LuNZ', 'uQuZc', 'GLYrA', 'YuaNd', 'QcQAJ', 'YOaAb', 'UYZlZ', 'vuJZu', 'JAdLm', 'NaAQd', 'UAcdu', 'UdlGQ', 'Amacl', 'NLQGm', 'ZcGdN', 'UdYUQ', 'laYmr', 'auYAk', 'YUNkZ', 'OAblc', 'OLJbl', 'Udumd', 'LckGN', 'ALOrl', 'AmQOY', 'kabJb', 'ZYcQU', 'GumLl', 'kGamN', 'NAacQ', 'kbmZO', 'aOLZU', 'OYuvb', 'lYrua', 'Zvalv', 'Qclad', 'GNAca', 'adYrc', 'LvuOG', 'mZUrQ', 'cuOJb', 'mkmJN', 'YNrAm', 'GJGcZ', 'rbYbu', 'QbkAc', 'dvNvA', 'Juaml', 'rvOvU', 'kLvdN', 'NbmQU', 'rdLJa', 'OAmGr', 'advYO', 'vkYGl', 'uQkrd', 'mLdkZ', 'bNdmG', 'ObZbA', 'QOLmu', 'dmZvm', 'ZNLOv', 'AlQaQ', 'bYGOZ', 'vAuNl', 'LNUrJ', 'QLrOJ', 'ubALm', 'UaZma', 'kdaAJ', 'LcNUJ', 'ZdNmU', 'bdUNu', 'ckLAL', 'NvuGr', 'NbacA', 'YJLcA', 'aNYmb', 'rcmuv', 'vmuLl', 'ZkGmY', 'YLQmG', 'dGLAl', 'aLNlk', 'ObOQl', 'AZlLN', 'mUOcO', 'Ldrbv', 'damYb', 'AZaJc', 'LOLkU', 'ckduA', 'OQarQ', 'ZJLmr', 'rGUAY', 'GLluA', 'OdlNm', 'LAclA', 'JmvmO', 'JZOAk', 'JdOAY'];
      const L2affixes_list = ['TAm', 'YcM', 'tAY', 'OMC', 'DKP', 'mAM', 'DOk', 'mhc', 'YBO', 'ATc', 'PTl', 'Cdt', 'lRE', 'BCD', 'cDR', 'Akd', 'EcR', 'RDM', 'cPK', 'PMd', 'Tmc', 'tcB', 'ABb', 'OYK', 'Dmh', 'mCd', 'OBT', 'PED', 'dPc', 'OPE', 'TRK', 'tRb', 'dRA', 'YDE', 'bRC', 'Yht', 'OtM', 'APT', 'EAO', 'bTE', 'CEM', 'kBD', 'dBC', 'BbM', 'KmE', 'kPM', 'kKE', 'hBK', 'Tbk', 'MAB', 'TRkY', 'MCkm', 'AdYl', 'RCdc', 'CmYA', 'KlkD', 'dmRb', 'YKPB', 'dTAh', 'dEPD', 'KEdl', 'EKBO', 'EPBT', 'CPMl', 'YTOM', 'OdOP', 'KOYC', 'dCKc', 'RYlD', 'cthB', 'bAMO', 'BCAd', 'CMdP', 'APEM', 'AlKD', 'lMck', 'BYhT', 'RdCc', 'mtKP', 'cMRl', 'MKmY', 'khMD', 'YbBT', 'bdtK', 'TmTm', 'kDOm', 'kMEC', 'DlDT', 'CKOb', 'BRDh', 'PMYm', 'TPOM', 'DbMR', 'hRKm', 'DOAK', 'hEct', 'mKcD', 'PEdK', 'Ckbd', 'YDTk'];
      const L2stems_list = ['hbmA', 'bROC', 'OCmk', 'kKRC', 'KdAR', 'BbOD', 'DhCP', 'AdDb', 'TdTD', 'TdmA', 'EMYK', 'AbKD', 'RhPm', 'OdYP', 'DCmh', 'KElB', 'BPAl', 'hkRK', 'KDPA', 'TEBK', 'mARM', 'dKRD', 'AMkC', 'mdkK', 'tdDd', 'Ctmb', 'CYPc', 'DBkl', 'PYkC', 'tRdM', 'kPOt', 'hTDd', 'YObA', 'Ehbt', 'RCcE', 'ctkt', 'TklD', 'hChY', 'chAh', 'COTK', 'mBYl', 'lBlE', 'EhRm', 'TDKh', 'CmcO', 'TKDk', 'dYdA', 'tmYh', 'BEPO', 'OtlR', 'McMD', 'khmh', 'OEPk', 'lRCB', 'YmBd', 'ORbk', 'mBbK', 'OcYM', 'AlTd', 'DhMt', 'lTmO', 'EdBb', 'DlDd', 'ACcO', 'bAdk', 'RtRh', 'KMOc', 'DBlh', 'bcOR', 'MhKd', 'kcOY', 'blMk', 'MBmE', 'OMlT', 'mhtc', 'tmAK', 'MDKP', 'PlEK', 'kCRm', 'Ddck', 'tRPD', 'RKYk', 'hbkd', 'MTdY', 'PdDT', 'bcbM', 'PcBT', 'DMRP', 'TPCb', 'YlYc', 'Mlth', 'ktBd', 'PEtE', 'YKRk', 'hCkt', 'hlkT', 'lBKt', 'BECk', 'KABA', 'dRht', 'kKEdM', 'dClOC', 'DmAME', 'EltMB', 'KRARm', 'tKDmh', 'PCMPK', 'kcCRt', 'EPMDk', 'htmhC', 'KAERM', 'DOchl', 'EtMDM', 'DRPkY', 'BKDRY', 'EPERd', 'bmdAB', 'CDEmY', 'lhCTC', 'hYDmt', 'PMPtk', 'BOCRM', 'kcdOt', 'TObCO', 'OAmAd', 'lbBDE', 'hAROK', 'hlbtb', 'hmKPM', 'DcPTc', 'btlck', 'kDRKc', 'cdKBY', 'BMEMA', 'dTmED', 'TAdhM', 'KMDYt', 'ECtbD', 'KBKBE', 'bRABt', 'RkmdC', 'AYkEh', 'lAOKM', 'MkmEd', 'Blmcl', 'chEDO', 'dRbDb', 'kdEdY', 'PctRC', 'dMThk', 'BOckP', 'hTtBb', 'lKdbc', 'hlctE', 'ODBDA', 'COtBD', 'YlCPB', 'DkTCP', 'EYtYR', 'kRCkO', 'cBROB', 'dCtMA', 'thbOM', 'TbKME', 'ckdAm', 'OmtlD', 'cDOEB', 'KTDTB', 'CkBOP', 'RdPtD', 'PDPhl', 'dKDth', 'cRElD', 'lRckA', 'cROMt', 'PCPDh', 'BATOc', 'Phktk', 'PEkhA', 'dMYBP', 'Cchtd', 'DBPhc', 'tcYbd', 'MBKRE', 'BdtAC', 'hBmMC', 'RYtkc', 'DOBhY', 'RlAKc', 'mBmlA', 'kPkRA', 'tDPRk', 'dOYml', 'kMbTR', 'ABPRB', 'tmtEM', 'lCbcm', 'EMbDP', 'CRdBd', 'TCbDC'];
      return [L1affixes_list, L1stems_list, L2affixes_list, L2stems_list]
    };

    function cycle_through(L1affixes_list, L1stems_list, L2affixes_list, L2stems_list) {
      const testingaffix_indices = [0,1,2,3,4,1,2,3,4,0];
    
      function wordcycle(affixes,stems) {
        var reps = 0;
        var words_list = [];
        var listlength = words_list.length;
        while (listlength < 50) {
          var words_list = [];
          var congruenttesting_list = [];
          var words_dict = {};
          var congruenttesting_dict = {};
          var training_dict = {};
          var affix_subset = jsPsych.randomization.sampleWithoutReplacement(affixes, 5);
          var stem_subset = jsPsych.randomization.sampleWithoutReplacement(stems, 10);
          reps++; /* increase by 1 */ 
          console.log('Finished rep ' + reps + ' of generating word list.')
          for (let i = 0; i < stem_subset.length; i++) {
            var j = 0;
            while (j < affix_subset.length) {
              var stem = stem_subset[i];
              var last = stem.slice(-1); //
              var affix = affix_subset[j];
              if (stem != affix && last != affix[0]) {
                words_list.push([stem + affix]); /* append */ 
                var parts = [stem, affix];
                var word = stem + affix;
                var dictkeys = Object.keys(words_dict);
                if (dictkeys.includes(word) == false) {
                  words_dict[word] = parts
                };
              };
              j++;
            };
            var indice = testingaffix_indices[i];
            var affix = affix_subset[indice];
            var stem = stem_subset[i];
            var word = stem + affix;
            if (congruenttesting_list.includes(word) == false) {
              congruenttesting_list.push([stem + affix]);
              var parts = [stem, affix];
              var word = stem + affix;
              congruenttesting_dict[word] = parts
            };
          };
          var words_list = Object.keys(words_dict);
          var listlength = words_list.length;
          if (listlength < 50) {
            var affix_subset = [];
            var stem_subset = [];
            var words_list = [];
            var congruenttesting_list = [];
            var words_dict = {};
            var congruenttesting_dict = {};
            var training_dict = {}
          };
        };
        if (words_list.length == 50) {
          console.log('Finished testing word list.');
          congruenttesting_list2 = [...congruenttesting_list];
          var congruenttesting_list = [];
          var training_dict = Object.assign({}, words_dict);
          var training_list = Object.keys(training_dict);
          for (word of congruenttesting_list2) {
            var word = word.toString();
            congruenttesting_list.push(word)
          };
          for (let i = 0; i < congruenttesting_list.length; i++) {
            var word = congruenttesting_list[i];
            var training_list = Object.keys(training_dict);
            if (training_list.includes(word)) {
              delete training_dict[word];
            };
          };
          var training_list = Object.keys(training_dict);
        };
        return [affix_subset, stem_subset, words_dict, words_list, training_dict, training_list, congruenttesting_dict, congruenttesting_list]
      };

      function cross_language_testing(L1affixsubset_list, L1stemsubset_list, L2affixsubset_list, L2stemsubset_list) {
        const testingaffix_indices = [0,1,2,3,4,1,2,3,4,0];
        incongruenttesting_list = [];
        incongruenttesting_dict = {};
        for (let i = 0; i < L1stemsubset_list.length; i++) {
          var indice = testingaffix_indices[i];
          var affix = L1affixsubset_list[indice];
          var stem = L2stemsubset_list[i];
          var word = stem + affix;
          if (stem[-1] != affix[0] && incongruenttesting_list.includes(word) == false) {
            incongruenttesting_list.push([stem + affix]);
            var word = stem + affix;
            incongruenttesting_dict[word] = parts
          };
        };
        for (let j = 0; j < L2stemsubset_list.length; j++) {
          var indice = testingaffix_indices[j];
          var affix = L2affixsubset_list[indice];
          var stem = L1stemsubset_list[j];
          var word = stem + affix;
          if (stem[-1] != affix[0] && incongruenttesting_list.includes(word) == false) {
            incongruenttesting_list.push([stem + affix]);
            var parts = [stem, affix];
            var word = stem + affix;
            incongruenttesting_dict[word] = parts
          };
        };
        return [incongruenttesting_list, incongruenttesting_dict]
      };
    
      /* generate word lists for both languages */
      var incongruenttesting_list = [];
      while (incongruenttesting_list.length < 20) {
        var values = wordcycle(L1affixes_list, L1stems_list);
        var L1affixsubset_list = values[0];
        var L1stemsubset_list = values[1];
        var L1words_dict = values[2];
        var L1words_list = values[3];
        var L1training_dict = values[4];
        var L1training_list = values[5];
        var L1congruenttesting_dict = values[6];
        var L1congruenttesting_list = values[7];
        var values2 = wordcycle(L2affixes_list, L2stems_list);
        var L2affixsubset_list = values2[0];
        var L2stemsubset_list = values2[1];
        var L2words_dict = values2[2];
        var L2words_list = values2[3];
        var L2training_dict = values2[4];
        var L2training_list = values2[5];
        var L2congruenttesting_dict = values2[6];
        var L2congruenttesting_list = values2[7];
        var training_list = L1training_list.concat(L2training_list);
        var training_dict = Object.assign({},L1training_dict,L2training_dict);
        var congruenttesting_list = L1congruenttesting_list.concat(L2congruenttesting_list);
        var congruenttesting_dict = Object.assign({},L1congruenttesting_dict,L2congruenttesting_dict);
        var values3 = cross_language_testing(L1affixsubset_list, L1stemsubset_list, L2affixsubset_list, L2stemsubset_list);
        var incongruenttesting_list = values3[0];
        var incongruenttesting_dict = values3[1];
        for (let i = 0; i < incongruenttesting_list.length; i++) {
          var word = congruenttesting_list[i];
          var training_list = Object.keys(training_dict);
          if (training_list.includes(word)) {
            delete training_dict[word];
          };
        };
        var training_list = Object.keys(training_dict);
        
      };
      var all_morphemes = Object.values(training_dict);
      var all_morphemes = all_morphemes.flat();
      var all_morphemes = [...new Set(all_morphemes)];
      all_morphemes.sort((a, b) => a.length - b.length);
      var exp_threes = [];
      var exp_fours = [];
      var exp_fives = [];
      for (morpheme of all_morphemes) {
        if (morpheme.length == 3) {
          exp_threes.push(morpheme)
        };
        if (morpheme.length == 4) {
          exp_fours.push(morpheme)
        };
        if (morpheme.length == 5) {
          exp_fives.push(morpheme)
        };
      };
      var big_threes = [];
      var big_fours = [];
      var big_fives = [];
      for (morpheme of L1affixes_list) {
        if (morpheme.length == 3 && all_morphemes.includes(morpheme) == false) {
          big_threes.push(morpheme)
        };
        if (morpheme.length == 4 && all_morphemes.includes(morpheme) == false) {
          big_fours.push(morpheme)
        };
      };
      for (morpheme of L1stems_list) {
        if (morpheme.length == 4 && all_morphemes.includes(morpheme) == false) {
          big_fours.push(morpheme)
        };
        if (morpheme.length == 5 && all_morphemes.includes(morpheme) == false) {
          big_fives.push(morpheme)
        };
      };
      for (morpheme of L2affixes_list) {
        if (morpheme.length == 3 && all_morphemes.includes(morpheme) == false) {
          big_threes.push(morpheme)
        };
        if (morpheme.length == 4 && all_morphemes.includes(morpheme) == false) {
          big_fours.push(morpheme)
        };
      };
      for (morpheme of L2stems_list) {
        if (morpheme.length == 4 && all_morphemes.includes(morpheme) == false) {
          big_fours.push(morpheme)
        };
        if (morpheme.length == 5 && all_morphemes.includes(morpheme) == false) {
          big_fives.push(morpheme)
        };
      };
      var all_confounds = [];
      var confound_threes = [];
      var confound_fours = [];
      var confound_fives = [];
      confound_threes = jsPsych.randomization.sampleWithoutReplacement(big_threes, parseInt(exp_threes.length));
      confound_fours = jsPsych.randomization.sampleWithoutReplacement(big_fours, parseInt(exp_fours.length));
      confound_fives = jsPsych.randomization.sampleWithoutReplacement(big_fives, parseInt(exp_fives.length));
      var all_confounds = confound_threes.concat(confound_fours, confound_fives);
      if (all_confounds.length == all_morphemes.length && confound_threes.length == exp_threes.length && confound_fours.length == exp_fours.length && confound_fives.length == exp_fives.length) {
        console.log("Correctly generated familiarity confound set.")
      };
      var familiarity_pairs = [];
      for (let i = 0; i < 30; i++) {
        familiarity_pairs.push([all_morphemes[i], all_confounds[i]])
      };
      return [L1affixsubset_list, L1stemsubset_list, L2affixsubset_list, L2stemsubset_list, L1words_dict, L1words_list, L1training_dict, L1training_list, L1congruenttesting_dict, L1congruenttesting_list, L2words_dict, L2words_list, L2training_dict, L2training_list, L2congruenttesting_dict, L2congruenttesting_list, training_list, training_dict, congruenttesting_list, congruenttesting_dict, incongruenttesting_list, incongruenttesting_dict, familiarity_pairs]
    };

    var values4 = import_morphemes();
    var L1affixes_list = values4[0];
    var L1stems_list = values4[1];
    var L2affixes_list = values4[2];
    var L2stems_list = values4[3];
    var values5 = cycle_through(L1affixes_list, L1stems_list, L2affixes_list, L2stems_list);
    var L1affixsubset_list = values5[0];
    var L1stemsubset_list = values5[1];
    var L2affixsubset_list = values5[2];
    var L2stemsubset_list = values5[3];
    var L1words_dict = values5[4];
    var L1words_list = values5[5];
    var L1training_dict = values5[6];
    var L1training_list = values5[7];
    var L1congruenttesting_dict = values5[8];
    var L1congruenttesting_list = values5[9];
    var L2words_dict = values5[10];
    var L2words_list = values5[11];
    var L2training_dict = values5[12];
    var L2training_list = values5[13];
    var L2congruenttesting_dict = values5[14];
    var L2congruenttesting_list = values5[15];
    var training_list = values5[16];
    var training_dict = values5[17];
    var congruenttesting_list2 = values5[18];
    var congruenttesting_dict = values5[19];
    var incongruenttesting_list2 = values5[20];
    var incongruenttesting_dict = values5[21];
    var familiarity_pairs = values5[22];
    var incongruenttesting_list = [];
    for (word of incongruenttesting_list2) {
      var word = word.toString();
      incongruenttesting_list.push(word)
    };
    var congruenttesting_list = [];
    var congruenttesting = [];
    var incongruenttesting = [];
    for (word of congruenttesting_list2) {
      var word = word.toString();
      congruenttesting_list.push(word)
    };
    for (word of congruenttesting_list) {
      congruenttesting.push([word,0])
    };
    for (word of incongruenttesting_list) {
      incongruenttesting.push([word,1])
    };
    var testing = congruenttesting.concat(incongruenttesting);
    if (training_list.length == 80 && testing.length == 40) {
      console.log('Correctly generated complete stimuli set.')
    };

    console.log('Training list: ' + training_list);
    console.log(testing);

    function training_randomisation(training_list) {
      var listlength = training_list.length;
      var rand_lst = ['efjnpqsz'];
      var rep = 0;
      while (rand_lst.length < (listlength + 1)) {
        if (rep < 500) {
          var word = jsPsych.randomization.sampleWithoutReplacement(training_list, 1)[0];
          var last2_word = word.slice(-2);
          var last_training = rand_lst.slice(-1)[0];
          var last2_training = last_training.slice(-2);
          var first2_word = word.slice(0, 2);
          var first2_training = last_training.slice(0, 2);
          if (first2_word != first2_training && last2_word != last2_training && rand_lst.includes(word) == false) {
            rand_lst.push(word)
          };
          rep++;
        };
        if (rep >= 500) {
          var rand_lst = ['efjnpqsz'];
          var rep = 0
        }
      };
      rand_lst.shift();
      var rand_lst = rand_lst.flat();
      return rand_lst
    };
    
    function testing_randomisation(testing) {
      var listlength = testing.length;
      var rand_lst = [['efjnpqsz',0]];
      var rep = 0;
      while (rand_lst.length < (listlength+1)) {
        if (rep < 500) {
          var item = jsPsych.randomization.sampleWithoutReplacement(testing, 1)[0];
          var word = item[0];
          var word_condition = item[1];
          var last_item = rand_lst.slice(-1)[0];
          var last_word = last_item.slice(0)[0];
          var first2_word = word.slice(0, 2);
          var first2_last_word = last_word.slice(0, 2);
          var last2_word = word.slice(-2);
          var last2_last_word = last_word.slice(-2);
          if (first2_word != first2_last_word && last2_word != last2_last_word && rand_lst.includes(item) == false) {
            rand_lst.push(item)
          };
          rep++
        };
        if (rep >= 500) {
          var rand_lst = [['efjnpqsz',0]];
          var rep = 0;
        }
      };
      rand_lst.shift();
      return rand_lst
    };

    function FisherYatesShuffle(array) {
      var m = array.length, t, i;
      while (m) {
        i = Math.floor(Math.random() * m--);
        t = array[m];
        array[m] = array[i];
        array[i] = t;
      }
    return array;
    };

    var trainingn = 4;
    var rand_training1 = training_randomisation(training_list);
    var rand_training2 = training_randomisation(training_list);
    var rand_training3 = training_randomisation(training_list);
    var rand_training4 = training_randomisation(training_list);
    // to be run for 8 training reps:
    /*
    var rand_training5 = training_randomisation(training_list);
    var rand_training6 = training_randomisation(training_list);
    var rand_training7 = training_randomisation(training_list);
    var rand_training8 = training_randomisation(training_list);
    */
    var rand_testing = testing_randomisation(testing);
    var familiarity_pairs = FisherYatesShuffle(familiarity_pairs);


    /* ========== JSPSYCH SCRIPT ========== */
    document.body.style.backgroundColor = "#808080";

    // change text colour to white
    function changeTextColor(color) {
      var body = document.getElementsByTagName("body")[0];
      body.style.color = color;
    };

    changeTextColor("white");

    /* Participant ID textbox */
    var sbjIDPrompt = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Prolific ID:</b></p>',
      html: '<input name="ID" type="text" required/></p>',
      button_label: "Continuare"
    };
    timeline.push(sbjIDPrompt);

    var instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p style="font-size: 15px;">Prima di cominciare, le chiediamo di leggere il modulo di consenso informato e confermare la sua volontà di partecipare all'esperimento.</p>
      <p style="font-size: 15px;"> La preghiamo di ricordare che questo è un progetto di ricerca e che la sua partecipazione è completamente volontaria. Lei si potra' ritirare in qualunque momento, senza necessariamente dover dare alcuna spiegazione. Lo studio al quale Le si chiede di partecipare ha lo scopo di esaminare come i lettori elaborano le parole scritte. La somministrazione delle prove è individuale. Lei sarà impegnato in una sessione di lavoro della durata media di 10 minuti, e un questionario di 10 minuti. L’ordine delle prove ed il loro svolgimento sono stabiliti in modo tale da evitare un eventuale affaticamento. Tutte le prove saranno precedute da un breve addestramento in modo tale che abbia la possibilità di familiarizzare con il compito. Sono previste alcune pause nel corso dello svolgimento dell’esperimento. Una ricompensa di £4 (£8 per ora) Le verrà consegnata al termine della sessione di testing. Nonostante il testing preveda delle prove cognitive, il presente esperimento non costituisce una prova clinica che permetta la diagnosi di eventuali patologie.</p>
      <p style="font-size: 15px;">Tutti i dati raccolti grazie alla partecipazione Sua e di altre persone volontarie saranno custoditi in server sicuri e protetti da password, e non sarà consentito ad alcuna persona non autorizzata di accedervi. Le Sue informazioni personali saranno conservate separatamente dai risultati della presente ricerca, cui saranno associati soltanto attraverso un ID arbitrario. Grazie a questo processo di anonimizzazione dei dati, a nessun ricercatore sarà possibile analizzare i risultati sapendo da quale specifico partecipante essi provengono. Inoltre, questa procedura renderà impossibile la Sua identificazione anche nel momento in cui i risultati della ricerca fossero pubblicati su riviste scientifiche, o presentati a congressi o in qualsiasi altro pubblico consesso. Più in generale, i dati raccolti saranno trattati in accordo con le leggi sulla privacy e in conformità al Decreto Legislativo 30 giugno 2003 n. 196 “Codice in materia di protezione dei dati personali” e al Regolamento Europeo 2016/679 (General Data Protection Regulation - GDPR). Il Responsabile della protezione dei dati (RPD) è l’Avv. Valentina Carollo che può essere contattato ai seguenti indirizzi email: <a href="mailto:dpo@sissa.it">dpo@sissa.it</a> oppure <a href="mailto:rpd@sissa.it">rpd@sissa.it</a> - PEC: <a href="mailto:protocollo@pec.sissa.it">protocollo@pec.sissa.it</a>.</p>
      <p style="font-size: 15px;"> Prima di esprimere il suo consenso alla partecipazione, Le ricordiamo ancora che in caso Lei abbia bisogno di delucidazioni su qualunque aspetto della procedura sperimentale, il ricercatore è a Sua completa disposizione (<a href="mailto:aliebelt@sissa.it">aliebelt@sissa.it</a>, <a href="mailto:davide.crepaldi@sissa.it">davide.crepaldi@sissa.it</a>).</p>
      <p style="font-size: 15px;">Se vuole scaricare il modulo di consenso informato, clicca qui: <a href="BASL_modulo_consenso.pdf" download>modulo di consenso</a>.</p>
      <p style="font-size: 15px;"> Le chiediamo di premere la barra per continuare al consenso.</p>`,
      choices: ' '
    };
    timeline.push(instructions);

    var consent = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p style="text-align:left;">Premere gli opzioni per esprimere il proprio consenso a partecipare allo studio. Dichiaro: </p>',
      html: `<p style="text-align:left;"><input name="consent1" type="radio" id="YES1" value="YES" required/><label for="YES1">di aver letto attentamente le spiegazioni relative a questo studio e all’intera procedura sperimentale;</label></p>
      <p style="text-align:left;"><input name="consent2" type="radio" id="YES2" value="YES" required/><label for="YES2">di essere stato informata/o riguardo alle finalità e agli obiettivi della ricerca in questione;</label></p>
      <p style="text-align:left;"><input name="consent3" type="radio" id="YES3" value="YES" required/><label for="YES3">di aver avuto la possibilità di porre domande a proposito di qualsiasi aspetto della procedura sperimentale e di aver ottenuto risposte soddisfacenti;</label></p>
      <p style="text-align:left;"><input name="consent4" type="radio" id="YES4" value="YES" required/><label for="YES4">di essere a conoscenza dei disagi eventualmente causati dall’esperimento;</label></p>
      <p style="text-align:left;"><input name="consent5" type="radio" id="YES5" value="YES" required/><label for="YES5">di aver ricevuto soddisfacenti assicurazioni sulla riservatezza delle informazioni ottenute dall’esame della propria persona;</label></p>
      <p style="text-align:left;"><input name="consent6" type="radio" id="YES6" value="YES" required/><label for="YES6">di essere consapevole di potersi ritirare in qualsiasi fase dello studio.</label></p>`
    };
    timeline.push(consent);

    var enter_fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: true,
      message: `<p>Si prega di premere il pulsante per accedere alla modalità a schermo intero. Se non vuole più partecipare, può uscire in qualsiasi momento con il tasto 'esc'.</p>`,
      button_label: 'Passare al schermo intero'
    };
    timeline.push(enter_fullscreen);

    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Benvenuta/o, e grazie mille del tuo tempo!</p>
      <p>In questo esperimento sarai un esperto/un'esperta di linguaggio cui è stato chiesto di dare un'occhiata ad alcuni messaggi che la Terra ha ricevuto dallo spazio. Il tuo compito, in questa prima parte dell'esperimento, sarà di fare molta attenzione alle parole che ti verranno mostrate; più tardi, i leader del mondo ti chiederanno qualche informazione su quello che hai visto. Le parole si susseguiranno abbastanza velocemente; sembra che questi alieni abbiano una certa fretta :-) </p>
      <p>Per favore, chiama lo sperimentatore se ha qualche domanda.</p><p>Premi la barra per continuare.</p>`,
      choices: ' '
    };
    timeline.push(welcome);

    var example = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Ecco un esempio delle parole che vedrai:</p>
      <img src='esempio.png' height='400px'>
      <p>Quando sei pronti per iniziare, premi la barra.</p></div>`,
      choices: ' '
    };
    timeline.push(example);

    /* TRAINING */
    var training_stimuli1 = [];
    var item = ' '
    for (let i = 0; i < rand_training1.length; i++) {
      var item = rand_training1[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict1 = {stimulus: java, correct_response: ''};
      training_stimuli1.push(training_stimuli_dict1)
    };
    
    var training_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: 'NO_KEYS',
      stimulus_duration: 800,
      trial_duration: 1000,
      response_ends_trial: false
    };

    var training_procedure1 = {
      timeline: [training_trial],
      timeline_variables: training_stimuli1,
    };
    timeline.push(training_procedure1);

    var inter_training1 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p>Ottimo, hai visto il primo blocco di parole. Ora puoi prenderti una piccola pausa.</p>
          <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
          choices: ' '
        };
    timeline.push(inter_training1);
    
    // training round 2
    var training_stimuli2 = [];
    for (let i = 0; i < rand_training2.length; i++) {
      var item = rand_training2[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict2 = {stimulus: java, correct_response: ''};
      training_stimuli2.push(training_stimuli_dict2)
    };

    var training_procedure2 = {
      timeline: [training_trial],
      timeline_variables: training_stimuli2,
    };
    timeline.push(training_procedure2);

    var inter_training2 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Ottimo, hai visto il secondo blocco di parole. Ora puoi prenderti una piccola pausa.</p>
      <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
      choices: ' '
    };
    timeline.push(inter_training2);

    // training round 3
    var training_stimuli3 = [];
    for (let i = 0; i < rand_training3.length; i++) {
      var item = rand_training3[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict3 = {stimulus: java, correct_response: ''};
      training_stimuli3.push(training_stimuli_dict3)
    };

    var training_procedure3 = {
      timeline: [training_trial],
      timeline_variables: training_stimuli3,
    };
    timeline.push(training_procedure3);

    var inter_training3 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Ottimo, hai visto il terzo blocco di parole. Ora puoi prenderti una piccola pausa.</p>
      <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
      choices: [' ']
    };
    timeline.push(inter_training3);

    // training round 4
    var training_stimuli4 = [];
    for (let i = 0; i < rand_training4.length; i++) {
      var item = rand_training4[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict4 = {stimulus: java, correct_response: ''};
      training_stimuli4.push(training_stimuli_dict4)
    };

    var training_procedure4 = {
      timeline: [training_trial],
      timeline_variables: training_stimuli4,
    };
    timeline.push(training_procedure4);

    // for 8 training reps:
    /*
    var inter_training4 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p>Ottimo, hai visto il quarto blocco di parole. Ora puoi prenderti una piccola pausa.</p>
          <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
          choices: ' '
        };
    timeline.push(inter_training4);
    
    // training round 5
    var training_stimuli5 = [];
    var item = ' '
    for (let i = 0; i < rand_training5.length; i++) {
      var item = rand_training5[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict5 = {stimulus: java, correct_response: ''};
      training_stimuli5.push(training_stimuli_dict1)
    };
    
    var training_trial5 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: 'NO_KEYS',
      stimulus_duration: 800,
      trial_duration: 1000,
      response_ends_trial: false
    };

    var training_procedure5 = {
      timeline: [training_trial5],
      timeline_variables: training_stimuli5,
    };
    timeline.push(training_procedure5);

    var inter_training5 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p>Ottimo, hai visto il quinto blocco di parole. Ora puoi prenderti una piccola pausa.</p>
          <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
          choices: ' '
        };
    timeline.push(inter_training5);
    
    // training round 6
    var training_stimuli6 = [];
    for (let i = 0; i < rand_training6.length; i++) {
      var item = rand_training6[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict6 = {stimulus: java, correct_response: ''};
      training_stimuli6.push(training_stimuli_dict6)
    };
    
    var training_trial6 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: 'NO_KEYS',
      stimulus_duration: 800,
      trial_duration: 1000,
      response_ends_trial: false
    };

    var training_procedure6 = {
      timeline: [training_trial6],
      timeline_variables: training_stimuli6,
    };
    timeline.push(training_procedure6);

    var inter_training6 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Ottimo, hai visto il sesto blocco di parole. Ora puoi prenderti una piccola pausa.</p>
      <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
      choices: ' '
    };
    timeline.push(inter_training6);

    // training round 7
    var training_stimuli7 = [];
    for (let i = 0; i < rand_training7.length; i++) {
      var item = rand_training7[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict7 = {stimulus: java, correct_response: ''};
      training_stimuli7.push(training_stimuli_dict7)
    };
    
    var training_trial7 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: 'NO_KEYS',
      stimulus_duration: 800,
      trial_duration: 1000,
      response_ends_trial: false
    };

    var training_procedure7 = {
      timeline: [training_trial7],
      timeline_variables: training_stimuli7,
    };
    timeline.push(training_procedure7);

    var inter_training7 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Ottimo, hai visto il settimo blocco di parole. Ora puoi prenderti una piccola pausa.</p>
      <p>Premi la barra quando sei pronta/o per riprendere.</p>`,
      choices: [' ']
    };
    timeline.push(inter_training7);

    // training round 8
    var training_stimuli8 = [];
    for (let i = 0; i < rand_training8.length; i++) {
      var item = rand_training8[i];
      var java = '<p style="font-size: 60px; font-family: BACS">'+item+'</p>';
      var training_stimuli_dict8 = {stimulus: java, correct_response: ''};
      training_stimuli8.push(training_stimuli_dict8)
    };
    
    var training_trial8 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: 'NO_KEYS',
      stimulus_duration: 800,
      trial_duration: 1000,
      response_ends_trial: false
    };

    var training_procedure8 = {
      timeline: [training_trial8],
      timeline_variables: training_stimuli8,
    };
    timeline.push(training_procedure8);
    */

    var post_training = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Ottimo! Hai visto tutte le parole che abbiamo ricevuto dallo spazio.</p>
      <p>Premi la barra quando sei pronta/o per continuare.</p>`,
      choices: ' '
    };
    timeline.push(post_training);

    /* TESTING */
    var pre_testing = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>In questa seconda parte, vedrai delle nuove parole che abbiamo ricevuto dallo stesso gruppo di alieni, e altre che invece provengono da un'altra comunicazione, con un altro gruppo di alieni. Purtroppo le due comunicazioni non arrivano a noi separatamente, per cui le parole sono mescolate tra loro. Il tuo compito sarà quello di individuare le parole che provengono dal gruppo che hai studiato nella prima parte dell'esperimento.</p>
      <p>Questo compito non è per nulla facile; le due comunicazioni infatti usano gli stessi caratteri. Il tuo meeting con i leader mondiali inizia tra poco, per cui non avrai molto tempo per prendere la tua decisione; dovrai essere veloce. Cerca di fare del tuo meglio usando la tua intuizione; non hai tempo di stare a pensare a lungo su ogni singola parola.</p>
      <p>Premi <strong>k</strong> quando pensi che la parola che stai vedendo sia degli stessi alieni che hai studiato prima, e <strong>d</strong> quando invece pensi che la parola che stai vedendo venga dall'altra comunicazione, con il nuovo gruppo di alieni.</p><p>Premi la barra quando sei pronta/o per iniziare.</p>`,
      choices: ' '
    };
    timeline.push(pre_testing);

    var testing_stimuli = [];
    for (let i = 0; i < rand_testing.length; i++) {
      var item = rand_testing[i];
      var condition = item[1];
      var java1 = item[0];
      if (i < 3) {
        var java2 = '<p style="font-size: 30px;">La parola viene del gruppo di alieni che hai studiato prima?</p><br><p style="font-size: 60px; font-family: BACS">'+java1+'<p style="font-size: 15px">Premi <strong>k</strong> per sì, <strong>d</strong> per no.</p>'
      };
      if (i >= 3) {
        var java2 = '<p style="font-size: 30px">&emsp;</p><br><p style="font-size: 60px; font-family: BACS">'+java1+'<p style="font-size: 15px">Premi <strong>k</strong> per sì, <strong>d</strong> per no.</p>'
      };
      if (condition == 0) {
        var testing_stimuli_dict = {stimulus: java1, correct_response: 'k', java: java2}
      };
      if (condition == 1) {
        var testing_stimuli_dict = {stimulus: java1, correct_response: 'd', java: java2}
      };
      testing_stimuli.push(testing_stimuli_dict)
    };

    var testing_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('java'),
      choices: ['d', 'k'],
      data: {
        item: jsPsych.timelineVariable('stimulus'),
        task: 'testing',
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_finish: function(data){
        data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
      }
    };

    var if_trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p style="font-size: 30px; color: red">Attenzione! Sei stato troppo lento con questa parola.</p>
        <p style="font-size: 30px; color: red">Cerca di essere più veloce.</p><p></p><p>Premi la barra per continuare.</p>`,
        choices: ' '
    };

    var if_node = {
        timeline: [if_trial],
        conditional_function: function(){
            var lasttrial_rt = jsPsych.data.getLastTrialData().select('rt').values[0];
            if(lasttrial_rt > 2000) {
                return true;
            } else {
                return false
            }
        }
    };

    var testing_procedure = {
      timeline: [testing_trial, if_node],
      timeline_variables: testing_stimuli,
    };
    timeline.push(testing_procedure);

    var strategy_prompt = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Quale strategia (se ne avevi) hai utilizzato nel compito precedente?</b></p>',
      html: '<input name="testing_strategy" type="text" required/></p>',
      button_label: "Continuare"
    };
    timeline.push(strategy_prompt);

    /* FAMILIARITY TEST */
    var pre_familiarity = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Sei arrivata/o al meeting giusto in tempo, ottimo! I leader mondiali vorrebbero mandare un messaggio di risposta agli alieni, e hanno bisogno che tu li aiuti a riconoscere le combinazioni di lettere che hai visto nel loro linguaggio. Avrai da scegliere tra due alternative: una di esse viene dalle parole che hai visto, mentre l'altra no. E' importante che si riesca a essere amichevoli con questi alieni, per cui cerca di fare la scelta giusta!</p>
      <p>Premi <strong>d</strong> se pensi che la combinazione di lettere sulla <strong>sinistra</strong> sia quella che era presente nella comunicazione degli alieni, oppure <strong>k</strong> se invece pensi che sia quella sulla <strong>destra</strong>.</p>
      <p>Premi la barra quando sei pronta/o per cominciare.</p>`,
      choices: ' '
    };
    timeline.push(pre_familiarity);

    var familiarity_pairs_sides = [];
    for (let i = 0; i < familiarity_pairs.length; i++) {
      var side = Math.random() * 2 | 0;
      if (side == 0) {
        familiarity_pairs_sides.push([familiarity_pairs[i][0], familiarity_pairs[i][1], 'd'])
      };
      if (side == 1) {
        familiarity_pairs_sides.push([familiarity_pairs[i][1], familiarity_pairs[i][0], 'k'])
      }
    };

    var familiarity_stimuli = [];
    for (let i = 0; i < familiarity_pairs_sides.length; i++){
      var java1 = String(familiarity_pairs_sides[i][0]+'&emsp;&emsp;&emsp;&emsp;&emsp;'+familiarity_pairs_sides[i][1]);
      if (i < 3) {
        var java2 = '<p style="font-size: 30px;">Quale combinazione di lettere hai già visto?</p><br><p style="font-size: 60px; font-family: BACS">'+java1+'<p style="font-size: 15px">Premi <strong>d</strong> per questa combinazione di lettere&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Premi <strong>k</strong> per questa combinazione di lettere</p>'
      };
      if (i >= 3) {
        var java2 = '<p style="font-size: 30px">&emsp;</p><br><p style="font-size: 60px; font-family: BACS">'+java1+'<p style="font-size: 15px">Premi <strong>d</strong> per questa combinazione di lettere&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;Premi <strong>k</strong> per questa combinazione di lettere</p>'
      };
      if (familiarity_pairs_sides[i][2] == 'd') {
        var target2 = familiarity_pairs_sides[i][0];
        var confound2 = familiarity_pairs_sides[i][1]
      } else if (familiarity_pairs_sides[i][2] == 'k') {
        var target2 = familiarity_pairs_sides[i][1];
        var confound2 = familiarity_pairs_sides[i][0]
      };
      var familiarity_pairs_dict = {'target': target2, 'confound': confound2, 'correct_response': familiarity_pairs_sides[i][2], 'java': java2};
      familiarity_stimuli.push(familiarity_pairs_dict);
    };
    console.log(familiarity_stimuli);

    var familiarity_trial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('java'),
      choices: ['d', 'k'],
      data: {
        target: jsPsych.timelineVariable('target'),
        confound: jsPsych.timelineVariable('confound'),
        task: 'familiarity',
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_finish: function(data){
        data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
      }
    };

    var familiarity_procedure = {
      timeline: [familiarity_trial],
      timeline_variables: familiarity_stimuli,
    };
    timeline.push(familiarity_procedure);

    var pre_BLP = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p>Grazie per il tuo aiuto! Per finire, avremmo bisogno del suo aiuto per rispondere alle seguenti domande relative alla sua storia linguistica, uso, attività e competenze linguistiche.</p>
      <p> Il questionario contiene 19 domande e le portarà via solo 10 minuti. Dato che questo non è un test, non ci sono risposte giuste o sbagliate. Risponda, per favore, ad ogni domanda e lo faccia con sincerità: solo così potrà garantire il buon esito di questo esperimento.</p>
      <p>Premi la barra per iniziare.</p>`,
      choices: ' '
    };
    timeline.push(pre_BLP);

    /* BLP */
    var bio_info = {
      type: jsPsychSurveyHtmlForm,
      preamble: `<p style="font-size: 25px; color: black">INFORMAZIONI BIOGRAFICHE</b></p>`,
      html: `<legend>Età</legend><div><input name="Età" type="text" required/></p>
      <p><legend>Sesso</legend><input name="Sesso" type="radio" id="Donna" name="Sesso" value="Donna" required/><label for="Donna">Donna</label><input type="radio" id="Uomo" name="Sesso" value="Uomo"><label for="Uomo">Uomo</label><input type="radio" id="Altro" name="Sesso" value="Altro"><label for="Altro">Altro/preferirei non dire</label></p>
      <legend>Livello massimo di formazione</legend><div><input type="radio" id="Primaria" name="Formazione" value="Primaria" required><label for="Primaria">Primaria (6-11 anni)</label></div><div><input type="radio" id="Secondaria1" name="Formazione" value="Secondaria1"><label for="Secondaria1">Secondaria di primo grado (11-13 anni)</label></div><div><input type="radio" id="Secondaria2" name="Formazione" value="Secondaria2"><label for="Secondaria2">Secondaria di secondo grado (14-18 anni)</label></div><div><input type="radio" id="Uni" name="Formazione" value="Uni"><label for="Uni">Università (triennale - magistrale)</label></div><div><input type="radio" id="Uni2" name="Formazione" value="Uni2"><label for="Uni2">Alcuni corsi universitari</label></div><div><input type="radio" id="Master" name="Formazione" value="Master"><label for="Master">Master (primo livello - secondo livello)</label></div><div><input type="radio" id="Dott" name="Formazione" value="Dott"><label for="Dott">Dottorato</label></div></p>
      <p><legend>Quale lingua considera come la sua <strong>LINGUA PRINCIPALE</strong>? (La lingua con la quale si sente più a suo agio). Nelle prossime domande faremo riferimento a questa lingua come la sua <strong>"L1"</strong>.</legend><input name="L1" type="text" required/></p>
      <p><legend>Quale lingua considera come la sua <strong>SECONDA LINGUA</strong>? Nelle prossime domande faremo riferimento a questa lingua come la sua <strong>"L2"</strong>. Se non sa una seconda lingua, scriva "n/a" per favore.</legend><input name="L2" type="text" required/></p>
      <p><legend>Quale lingua considera come la sua <strong>TERZA LINGUA</strong>? Nelle prossime domande faremo riferimento a questa lingua come la sua <strong>"L3"</strong>. Se non sa una terza lingua, scriva "n/a" per favore</legend><input name="L3" type="text" required/></p>
      <p><legend>Quale lingua considera come la sua <strong>QUARTA LINGUA</strong>? Nelle prossime domande faremo riferimento a questa lingua come la sua <strong>"L4"</strong>. Se non sa una quarta lingua, scriva "n/a" per favore</legend><input name="L4" type="text" required/></p>
      <p><legend>Parla altre lingue?</legend><input name="otherLs" type="text" required/></p>`,
      button_label: "Continuare",
      data: {name: 'bio_info'}
    };
    timeline.push(bio_info);

    // history section
    function anni (question) {
      var options = [];
      var nameL1 = String(question + 'L1');
      var nameL2 = String(question + 'L2');
      var nameL3 = String(question + 'L3');
      var nameL4 = String(question + 'L4');
      var L1_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L1'];
      var L2_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L2'];
      var L3_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L3'];
      var L4_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L4'];
      for (let l=0; l < 4; l++) {
        if (l == 0) {
          var tag = L1_tag;
          var name = nameL1;
          var color = "#eb9c9a"
        };
        if (l == 1) {
          var tag = L2_tag;
          var name = nameL2;
          var color = "#ac0d30"
        };
        if (l == 2) {
          var tag = L3_tag;
          var name = nameL3;
          var color = "#bfbcfc"
        };
        if (l == 3) {
          var tag = L4_tag;
          var name = nameL4;
          var color = "#da9d37"
        };
        if (question == 'AoA') {var extras = `<input type="radio" id="`+ name +`_0" name="`+ name +`" value="0"><label for="`+ name +`_0">Dalla nascita</label>`;};
        if (question == 'AoAgio') {var extras = `<input type="radio" id="`+ name +`_0" name="`+ name +`" value="0"><label for="`+ name +`_0">Da quando ne ho ricordo</label><input type="radio" id="`+ name +`_notyet" name="`+ name +`" value="notyet"><label for="`+ name +`_notyet">Non ancora</label>`};
        if (question == 'anniInstr') {var extras = `<input type="radio" id="`+ name +`_0" name="`+ name +`" value="0"><label for="`+ name +`_0">0</label>`};
        if (question == 'anniPaese') {var extras = `<input type="radio" id="`+ name +`_0" name="`+ name +`" value="0"><label for="`+ name +`_0">0</label>`};
        if (question == 'anniFamiglia') {var extras = `<input type="radio" id="`+ name +`_0" name="`+ name +`" value="0"><label for="`+ name +`_0">0</label>`};
        if (question == 'anniLavoro') {var extras = `<input type="radio" id="`+ name +`_0" name="`+ name +`" value="0"><label for="`+ name +`_0">0</label>`};
        if (tag == 'n/a' || tag == 'na' || tag == 'NA' || tag == 'N/A' || tag == 'no' || tag == 'NO') {var option = ''} else {
          var option = `<strong><font color="`+ color +`">`+ tag +`: </strong></font>
          `+ extras +`
          <input type="radio" id="`+ name +`_1" name="`+ name +`" value="1" required/><label for="`+ name +`_1">1</label>
          <input type="radio" id="`+ name +`_2" name="`+ name +`" value="2" required/><label for="`+ name +`_2">2</label>
          <input type="radio" id="`+ name +`_3" name="`+ name +`" value="3" required/><label for="`+ name +`_3">3</label>
          <input type="radio" id="`+ name +`_4" name="`+ name +`" value="4" required/><label for="`+ name +`_4">4</label>
          <input type="radio" id="`+ name +`_5" name="`+ name +`" value="5" required/><label for="`+ name +`_5">5</label>
          <input type="radio" id="`+ name +`_6" name="`+ name +`" value="6" required/><label for="`+ name +`_6">6</label>
          <input type="radio" id="`+ name +`_7" name="`+ name +`" value="7" required/><label for="`+ name +`_7">7</label>
          <input type="radio" id="`+ name +`_8" name="`+ name +`" value="8" required/><label for="`+ name +`_8">8</label>
          <input type="radio" id="`+ name +`_9" name="`+ name +`" value="9" required/><label for="`+ name +`_9">9</label>
          <input type="radio" id="`+ name +`_10" name="`+ name +`" value="10" required/><label for="`+ name +`_10">10</label>
          <input type="radio" id="`+ name +`_11" name="`+ name +`" value="11" required/><label for="`+ name +`_11">11</label>
          <input type="radio" id="`+ name +`_12" name="`+ name +`" value="12" required/><label for="`+ name +`_12">12</label>
          <input type="radio" id="`+ name +`_13" name="`+ name +`" value="13" required/><label for="`+ name +`_13">13</label>
          <input type="radio" id="`+ name +`_14" name="`+ name +`" value="14" required/><label for="`+ name +`_14">14</label>
          <input type="radio" id="`+ name +`_15" name="`+ name +`" value="15" required/><label for="`+ name +`_15">15</label>
          <input type="radio" id="`+ name +`_16" name="`+ name +`" value="16" required/><label for="`+ name +`_16">16</label>
          <input type="radio" id="`+ name +`_17" name="`+ name +`" value="17" required/><label for="`+ name +`_17">17</label>
          <input type="radio" id="`+ name +`_18" name="`+ name +`" value="18" required/><label for="`+ name +`_18">18</label>
          <input type="radio" id="`+ name +`_19" name="`+ name +`" value="19" required/><label for="`+ name +`_19">19</label>
          <input type="radio" id="`+ name +`_20+" name="`+ name +`" value="20+" required/><label for="`+ name +`_20+">20+</label></p>`;
          };
        options.push(option)
      };
      var options = options.toString();
      var options = options.replace(/,/g,'');
      return options
    };

    var history_info = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p style="font-size: 25px; color: black">ANAMNESI LINGUISTICA</p><p style="color: black">In questa sezione, le chiediamo di rispondere alle seguenti domande sulla sua storia linguistica. Si prega di rispondere a ciascuna domanda facendo clic sul pulsante appropriato.</p>',
      html: function(){
        var AoA = anni('AoA');
        var AoAgio = anni('AoAgio');
        var anniInstr = anni('anniInstr');
        var anniPaese = anni('anniPaese');
        var anniFamiglia = anni('anniFamiglia');
        var anniLavoro = anni('anniLavoro');
        var big_html = `<p style="color: black"><legend>1. A quanti anni iniziò ad imparare le seguenti lingue?</legend></p>` + AoA + `</p><p style="color: black"><legend>2. A quanti anni iniziò a sentirsi a proprio agio usando le seguenti lingue?</legend></p>` + AoAgio + `</p><p style="color: black"><legend>3. Per quanti anni ha ricevuto un’ istruzione (grammatica, storia, matematica, etc..) nelle seguenti lingue (a partire dalla scuola primaria fino all’università)?</legend></p>` + anniInstr + `</p><p style="color: black"><legend>4. Quanti anni ha passato in un Paese/regione in cui si parlano le seguenti lingue?</legend></p>` + anniPaese + `</p><p style="color: black"><legend>5. Quanti anni ha trascorso in famiglia parlando le seguenti lingue?</legend></p>` + anniFamiglia + `</p><p style="color: black"><legend>6. Quanti anni ha trascorso in un ambiente di lavoro in cui si parlano le seguenti lingue?</legend></p>` + anniLavoro;
        return big_html
      }
    };
    timeline.push(history_info);

    // use section
    function percent (question) {
      var options = []
      var nameL1 = String(question + 'L1');
      var nameL2 = String(question + 'L2');
      var nameL3 = String(question + 'L3');
      var nameL4 = String(question + 'L4');
      var L1_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L1'];
      var L2_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L2'];
      var L3_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L3'];
      var L4_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L4'];
      for (let l=0; l < 4; l++) {
        if (l == 0) {
          var tag = L1_tag;
          var name = nameL1;
          var color = "#eb9c9a"
        };
        if (l == 1) {
          var tag = L2_tag;
          var name = nameL2;
          var color = "#ac0d30"
        };
        if (l == 2) {
          var tag = L3_tag;
          var name = nameL3;
          var color = "#bfbcfc"
        };
        if (l == 3) {
          var tag = L4_tag;
          var name = nameL4;
          var color = "#da9d37"
        };
        if (tag == 'n/a' || tag == 'na' || tag == 'NA' || tag == 'N/A' || tag == 'no' || tag == 'NO') {var option = ''} else {
          var option = `<strong><font color="`+ color +`">`+ tag +`: </strong></font>
          <input type="radio" id="`+ name +`_0" name ="`+ name +`" value="0" required/><label for="`+ name +`_0">0%</label>
          <input type="radio" id="`+ name +`_10" name="`+ name +`" value="10" required/><label for="`+ name +`_10">10%</label>
          <input type="radio" id="`+ name +`_20" name="`+ name +`" value="20" required/><label for="`+ name +`_20">20%</label>
          <input type="radio" id="`+ name +`_30" name="`+ name +`" value="30" required/><label for="`+ name +`_30">30%</label>
          <input type="radio" id="`+ name +`_40" name="`+ name +`" value="40" required/><label for="`+ name +`_40">40%</label>
          <input type="radio" id="`+ name +`_50" name="`+ name +`" value="50" required/><label for="`+ name +`_50">50%</label>
          <input type="radio" id="`+ name +`_60" name="`+ name +`" value="60" required/><label for="`+ name +`_60">60%</label>
          <input type="radio" id="`+ name +`_70" name="`+ name +`" value="70" required/><label for="`+ name +`_70">70%</label>
          <input type="radio" id="`+ name +`_80" name="`+ name +`" value="80" required/><label for="`+ name +`_80">80%</label>
          <input type="radio" id="`+ name +`_90" name="`+ name +`" value="90" required/><label for="`+ name +`_90">90%</label>
          <input type="radio" id="`+ name +`_100" name="`+ name +`" value="100" required/><label for="`+ name +`_100">100%</label></p>`;
        };
        options.push(option)
      };
      var options = options.toString();
      var options = options.replace(/,/g,'');
      return options
    };

    var use_info = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p style="font-size: 25px; color: black">USO DELLE LINGUE</p><p style="color: black">In questa sezione, le chiediamo di fornirci le sue risposte sull’uso delle lingue. La somma delle percentuali scelte per ogni lingua presentata nelle singole domande deve essere 100%. Si prega di rispondere a ciascuna domanda facendo clic sul pulsante appropriato.</p>',
      html: function() {
        var PercAmici = percent('PercAmici');
        var PercFamiglia = percent('PercFamiglia');
        var PercLavoro = percent('PercLavoro');
        var PercStesso = percent('PercStesso');
        var PercCalcoli = percent('PercCalcoli');
        var big_html = `<p style="color: black"><legend>7. In una settimana normale, in che percentuale (di tempo) fa uso delle seguenti lingue con i suoi amici?</legend></p>` + PercAmici + `</p>
        <p style="color: black"><legend>8. In una settimana normale, in che percentuale (di tempo) fa uso delle seguenti lingue con la sua famiglia?</legend></p>` + PercFamiglia + `</p>
        <p style="color: black"><legend>9. In una settimana normale, in che percentuale (di tempo) fa uso delle seguenti lingue a scuola/al lavoro?</legend></p>` + PercLavoro + `</p>
        <p style="color: black"><legend>10. Quando parla con se stesso, con quale frequenza parla a se stesso nelle seguenti lingue?</legend></p>` + PercStesso + `</p>
        <p style="color: black"><legend>11. Quando fa calcoli contando, con quale frequenza conta nelle seguenti lingue?</legend></p>` + PercCalcoli;
        return big_html
      }
    };
    timeline.push(use_info);

    // proficiency section
    function proficiency (question) {
      var options = [];
      var nameL1 = String(question + 'L1');
      var nameL2 = String(question + 'L2');
      var nameL3 = String(question + 'L3');
      var nameL4 = String(question + 'L4');
      var L1_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L1'];
      var L2_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L2'];
      var L3_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L3'];
      var L4_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L4'];
      for (let l=0; l < 4; l++) {
        if (l == 0) {
          var tag = L1_tag;
          var name = nameL1;
          var color = "#eb9c9a"
        };
        if (l == 1) {
          var tag = L2_tag;
          var name = nameL2;
          var color = "#ac0d30"
        };
        if (l == 2) {
          var tag = L3_tag;
          var name = nameL3;
          var color = "#bfbcfc"
        };
        if (l == 3) {
          var tag = L4_tag;
          var name = nameL4;
          var color = "#da9d37"
        };
        if (tag == 'n/a' || tag == 'na' || tag == 'NA' || tag == 'N/A' || tag == 'no' || tag == 'NO') {var option = ''} else {
          var option = `<strong><font color="`+ color +`">`+ tag +`: </strong></font><input type="radio" name="`+ name +`" id="`+ name +`_0" value="0" required/><label for="`+ name +`_0">0 (non molto bene)</label>
          <input type="radio" id="`+ name +`_1" name="`+ name +`" value="1" required/><label for="`+ name +`_1">1</label>
          <input type="radio" id="`+ name +`_2" name="`+ name +`" value="2" required/><label for="`+ name +`_2">2</label>
          <input type="radio" id="`+ name +`_3" name="`+ name +`" value="3" required/><label for="`+ name +`_3">3</label>
          <input type="radio" id="`+ name +`_4" name="`+ name +`" value="4" required/><label for="`+ name +`_4">4</label>
          <input type="radio" id="`+ name +`_5" name="`+ name +`" value="5" required/><label for="`+ name +`_5">5</label>
          <input type="radio" id="`+ name +`_6" name="`+ name +`" value="6" required/><label for="`+ name +`_6">6 (molto bene)</label></p>`;
        };
        options.push(option)
      };
      var options = options.toString();
      var options = options.replace(/,/g,'');
      return options
    };

    var proficiency_info = {
      type: jsPsychSurveyHtmlForm,
      preamble: `<p style="font-size: 25px; color: black">COMPETENZA</p>
      <p style="color: black">In questa sezione, le chiediamo di rispondere relativamente alla competenza linguistica. Si prega di rispondere a ciascuna domanda facendo clic sul pulsante appropriato.</p>`,
      html: function() {
        var ProfParla = proficiency('ProfParla');
        var ProfCapisce = proficiency('ProfCapisce');
        var ProfLegge = proficiency('ProfLegge');
        var Attention = proficiency('Attention');
        var ProfScrive = proficiency('ProfScrive');
        var big_html = `<p style="color: black"><legend>12. Come parla le seguenti lingue?</legend></p>` + ProfParla + `
        <p style="color: black"><legend>13. Come capisce le seguenti lingue?</legend></p>` + ProfCapisce + `
        <p style="color: black"><legend>14. Come legge nelle seguenti lingue?</legend></p>` + ProfLegge + `
        <p style="color: black"><legend>Se legge questa frase, la prega di rispondere "2" per tutte le lingue.</legend></p>` + Attention + `
        <p style="color: black"><legend>15. Come scrive nelle seguenti lingue?</legend></p>` + ProfScrive;
        return big_html
      }
    };
    timeline.push(proficiency_info);

    // attitudes section
    function attitudes (question) {
      var options = [];
      var nameL1 = String(question + 'L1');
      var nameL2 = String(question + 'L2');
      var nameL3 = String(question + 'L3');
      var nameL4 = String(question + 'L4');
      var L1_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L1'];
      var L2_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L2'];
      var L3_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L3'];
      var L4_tag = jsPsych.data.get().filter({name: 'bio_info'}).values()[0].response['L4'];
      for (let l=0; l < 4; l++) {
        if (l == 0) {
          var tag = L1_tag
          var name = nameL1;
          var color = "#eb9c9a"
        };
        if (l == 1) {
          var tag = L2_tag
          var name = nameL2;
          var color = "#ac0d30"
        };
        if (l == 2) {
          var tag = L3_tag
          var name = nameL3;
          var color = "#bfbcfc"
        };
        if (l == 3) {
          var tag = L4_tag
          var name = nameL4;
          var color = "#da9d37"
        };
        if (tag == 'n/a' || tag == 'na' || tag == 'NA' || tag == 'N/A' || tag == 'no' || tag == 'NO') {var option = ''} else {
          var option = `<strong><font color="`+ color +`">`+ tag +`: </strong></font><input type="radio" name="`+ name +`" id="`+ name +`_0" value="0" required/><label for="`+ name +`_0">0 (non sono d'accordo)</label>
          <input type="radio" id="`+ name +`_1" name="`+ name +`" value="1" required/><label for="`+ name +`_1">1</label>
          <input type="radio" id="`+ name +`_2" name="`+ name +`" value="2" required/><label for="`+ name +`_2">2</label>
          <input type="radio" id="`+ name +`_3" name="`+ name +`" value="3" required/><label for="`+ name +`_3">3</label>
          <input type="radio" id="`+ name +`_4" name="`+ name +`" value="4" required/><label for="`+ name +`_4">4</label>
          <input type="radio" id="`+ name +`_5" name="`+ name +`" value="5" required/><label for="`+ name +`_5">5</label>
          <input type="radio" id="`+ name +`_6" name="`+ name +`" value="6" required/><label for="`+ name +`_6">6 (sono d'accordo)</label></p>`;
        };
        options.push(option)
      };
      var options = options.toString();
      var options = options.replace(/,/g,'');
      return options
    };

    var attitudes_info = {
      type: jsPsychSurveyHtmlForm,
      preamble: `<p style="font-size: 25px; color: black">ATTEGGIAMENTO LINGUISTICO</p>
      <p style="color: black">In questa sezione, le chiediamo di fornirci risposte alle seguenti affermazioni relative ad atteggiamenti linguistici. Si prega di rispondere a ciascuna domanda facendo clic sul pulsante appropriato.</p>`,
      html: function() {
        var AttMiStesso = attitudes('AttMiStesso');
        var AttCultura = attitudes('AttCultura');
        var AttLivNativo = attitudes('AttLivNativo');
        var AttMadrelingua = attitudes('AttMadrelingua');
        var big_html = `<p style="color: black"><legend>16. Mi sento “me stesso” quando parlo le seguenti lingue.</legend></p>` + AttMiStesso + `
        <p style="color: black"><legend>17. Mi identifico con una cultura che parla le seguenti lingue.</legend></p>` + AttCultura + `
        <p style="color: black"><legend>18. Per me è importante raggiungere un livello nativo e usare ad un livello nativo le seguenti lingue.</legend></p>` + AttLivNativo + `
        <p style="color: black"><legend>19. Voglio che gli altri pensino che io sia un madrelingua delle seguenti lingue.</legend></p>` + AttMadrelingua;
        return big_html
      }
    };
    timeline.push(attitudes_info);

    var goodbye = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p><u>Motivo dello studio:</u> Questo esperimento intendeva testare se persone con maggire esperienza in più lingue  fossero più capaci di processare inconsciamente la statistica di nuove parole. Le parole aliene che hai visto all'inizio appartenevano a due diverse lingue, e tale diversità si esplicava in come diverse parti delle parole erano relate una all'altra. Grazie per la tua partecipazione!</p>
      <p>Premi un tasto qualsiasi per finire.</p>`
    };
    timeline.push(goodbye);

    var exit_fullscreen = {
      type: jsPsychFullscreen,
      fullscreen_mode: false,
      delay_after: 0
    };
    timeline.push(exit_fullscreen);

    var pavlovia_finish = {
      type: jsPsychPavlovia,
      command: "finish"
    };
    timeline.push(pavlovia_finish);

    jsPsych.run(timeline);
  </script>
</html>